<!DOCTYPE html>
<html lang="en">

  <!-- Head -->
  <head>        
    <!-- Metadata, OpenGraph and Schema.org -->
    

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Naeun  Oh | Functional Alignment Notebook</title>
    <meta name="author" content="Naeun  Oh" />
    <meta name="description" content="tutorial for functional alignment" />
    <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website" />


    <!-- Bootstrap & MDB -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous" />

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

    <!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://gitcdn.link/repo/jwarby/jekyll-pygments-themes/master/github.css" />

    <!-- Styles -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ”¥</text></svg>">
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="https://naeunoh.github.io/blog/2022/functional-alignment-code/">

    <!-- Dark Mode -->
    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/dark_mode.js"></script>
  </head>

  <!-- Body -->
  <body class="fixed-top-nav">

    <!-- Header -->
    <header>

      <!-- Nav Bar -->
      <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
        <div class="container">
          <a class="navbar-brand title font-weight-lighter" href="https://naeunoh.github.io/"><span class="font-weight-bold">Naeun</span>   Oh</a>
          <!-- Navbar Toggle -->
          <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar top-bar"></span>
            <span class="icon-bar middle-bar"></span>
            <span class="icon-bar bottom-bar"></span>
          </button>

          <div class="collapse navbar-collapse text-right" id="navbarNav">
            <ul class="navbar-nav ml-auto flex-nowrap">

              <!-- About -->
              <li class="nav-item ">
                <a class="nav-link" href="/">about</a>
              </li>
              
              <!-- Blog -->
              <li class="nav-item active">
                <a class="nav-link" href="/blog/">blog</a>
              </li>

              <!-- Other pages -->
              <li class="nav-item ">
                <a class="nav-link" href="/projects/">projects</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/publications/">publications</a>
              </li>
              <li class="nav-item dropdown ">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus</a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="/publications/">publications</a>
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" href="/projects/">projects</a>
                </div>
              </li>

              <!-- Toogle theme mode -->
              <div class="toggle-container">
                <a id="light-toggle">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
                </a>
              </div>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <!-- Content -->
    <div class="container mt-5">
      <!-- _layouts/post.html -->

<div class="post">

  <header class="post-header">
    <h1 class="post-title">Functional Alignment Notebook</h1>
    <p class="post-meta">July 16, 2022</p>
    <p class="post-tags">
      <a href="/blog/2022"> <i class="fas fa-calendar fa-sm"></i> 2022 </a>
      Â  Â· Â 
        <a href="/blog/tag/neuroimaging">
          <i class="fas fa-hashtag fa-sm"></i> neuroimaging</a> Â 
          <a href="/blog/tag/psychology">
          <i class="fas fa-hashtag fa-sm"></i> psychology</a> Â 
          <a href="/blog/tag/analysis-methods">
          <i class="fas fa-hashtag fa-sm"></i> analysis-methods</a> Â 
          
      Â  Â· Â 
        <a href="/blog/category/naturalistic-data-analysis">
          <i class="fas fa-tag fa-sm"></i> naturalistic-data-analysis</a> Â 
          

    </p>
  </header>

  <article class="post-content">
    <h1 id="functional-alignment">Functional Alignment</h1>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="kn">from</span> <span class="n">nltools.mask</span> <span class="kn">import</span> <span class="n">create_sphere</span><span class="p">,</span> <span class="n">expand_mask</span>
<span class="kn">from</span> <span class="n">nltools.data</span> <span class="kn">import</span> <span class="n">Brain_Data</span><span class="p">,</span> <span class="n">Adjacency</span>
<span class="kn">from</span> <span class="n">nltools.stats</span> <span class="kn">import</span> <span class="n">align</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="n">matplotlib.gridspec</span> <span class="k">as</span> <span class="n">gridspec</span>
<span class="kn">from</span> <span class="n">nilearn.plotting</span> <span class="kn">import</span> <span class="n">plot_stat_map</span>
<span class="kn">import</span> <span class="n">datalad.api</span> <span class="k">as</span> <span class="n">dl</span>
<span class="kn">import</span> <span class="n">warnings</span>

<span class="n">warnings</span><span class="p">.</span><span class="nf">simplefilter</span><span class="p">(</span><span class="sh">'</span><span class="s">ignore</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>It is highly recommended to configure Git before using DataLad. Set both 'user.name' and 'user.email' configuration variables.
</code></pre></div></div>

<h2 id="get-dataset-using-datalad">Get Dataset using datalad</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data_dir</span> <span class="o">=</span> <span class="sh">'</span><span class="s">/Users/naeun-oh/Sherlock</span><span class="sh">'</span>

<span class="c1"># If dataset hasn't been installed, clone from GIN repository
</span><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
    <span class="n">dl</span><span class="p">.</span><span class="nf">clone</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="sh">'</span><span class="s">https://gin.g-node.org/ljchang/Sherlock</span><span class="sh">'</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">data_dir</span><span class="p">)</span>

<span class="c1"># Initialize dataset
</span><span class="n">ds</span> <span class="o">=</span> <span class="n">dl</span><span class="p">.</span><span class="nc">Dataset</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>

<span class="n">ds</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">annex</span><span class="o">=</span><span class="sh">'</span><span class="s">all</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1;31muntracked[0m: fmriprep/sub-02/.DS_Store ([1;35mfile[0m)
1350 annex'd files (25.1 GB/109.0 GB present/total size)
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Get Cropped &amp; Denoised HDF5 Files  : takes a very very long time
</span><span class="n">result</span> <span class="o">=</span> <span class="n">ds</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">glob</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="sh">'</span><span class="s">fmriprep</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">*</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">func</span><span class="sh">'</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="s">*crop*hdf5</span><span class="sh">'</span><span class="p">)))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1;1mget[0m([1;32mok[0m): fmriprep/sub-01/func/sub-01_denoise_crop_smooth6mm_task-sherlockPart2_space-MNI152NLin2009cAsym_desc-preproc_bold.hdf5 ([1;35mfile[0m) [from origin...]
[1;1mget[0m([1;32mok[0m): fmriprep/sub-05/func/sub-05_denoise_crop_smooth6mm_task-sherlockPart1_space-MNI152NLin2009cAsym_desc-preproc_bold.hdf5 ([1;35mfile[0m) [from origin...]
[1;1mget[0m([1;32mok[0m): fmriprep/sub-06/func/sub-06_denoise_crop_smooth6mm_task-sherlockPart2_space-MNI152NLin2009cAsym_desc-preproc_bold.hdf5 ([1;35mfile[0m) [from origin...]
[1;1mget[0m([1;32mok[0m): fmriprep/sub-11/func/sub-11_denoise_crop_smooth6mm_task-sherlockPart1_space-MNI152NLin2009cAsym_desc-preproc_bold.hdf5 ([1;35mfile[0m) [from origin...]
[1;1mget[0m([1;32mok[0m): fmriprep/sub-12/func/sub-12_denoise_crop_smooth6mm_task-sherlockPart1_space-MNI152NLin2009cAsym_desc-preproc_bold.hdf5 ([1;35mfile[0m) [from origin...]
[1;1mget[0m([1;32mok[0m): fmriprep/sub-08/func/sub-08_denoise_crop_smooth6mm_task-sherlockPart2_space-MNI152NLin2009cAsym_desc-preproc_bold.hdf5 ([1;35mfile[0m) [from origin...]
[1;1mget[0m([1;32mok[0m): fmriprep/sub-02/func/sub-02_denoise_crop_smooth6mm_task-sherlockPart1_space-MNI152NLin2009cAsym_desc-preproc_bold.hdf5 ([1;35mfile[0m) [from origin...]
[1;1mget[0m([1;32mok[0m): fmriprep/sub-05/func/sub-05_denoise_crop_smooth6mm_task-sherlockPart2_space-MNI152NLin2009cAsym_desc-preproc_bold.hdf5 ([1;35mfile[0m) [from origin...]
[1;1mget[0m([1;32mok[0m): fmriprep/sub-04/func/sub-04_denoise_crop_smooth6mm_task-sherlockPart2_space-MNI152NLin2009cAsym_desc-preproc_bold.hdf5 ([1;35mfile[0m) [from origin...]
[1;1mget[0m([1;32mok[0m): fmriprep/sub-12/func/sub-12_denoise_crop_smooth6mm_task-sherlockPart2_space-MNI152NLin2009cAsym_desc-preproc_bold.hdf5 ([1;35mfile[0m) [from origin...]
[1;1mget[0m([1;32mok[0m): fmriprep/sub-06/func/sub-06_denoise_crop_smooth6mm_task-sherlockPart1_space-MNI152NLin2009cAsym_desc-preproc_bold.hdf5 ([1;35mfile[0m) [from origin...]
[1;1mget[0m([1;32mok[0m): fmriprep/sub-09/func/sub-09_denoise_crop_smooth6mm_task-sherlockPart1_space-MNI152NLin2009cAsym_desc-preproc_bold.hdf5 ([1;35mfile[0m) [from origin...]
[1;1mget[0m([1;32mok[0m): fmriprep/sub-04/func/sub-04_denoise_crop_smooth6mm_task-sherlockPart1_space-MNI152NLin2009cAsym_desc-preproc_bold.hdf5 ([1;35mfile[0m) [from origin...]
[1;1mget[0m([1;32mok[0m): fmriprep/sub-03/func/sub-03_denoise_crop_smooth6mm_task-sherlockPart1_space-MNI152NLin2009cAsym_desc-preproc_bold.hdf5 ([1;35mfile[0m) [from origin...]
action summary:
  get (notneeded: 18, ok: 14)
</code></pre></div></div>

<p>Hyperalignment was developed at Dartmouth College and is implemented in the PyMVPA toolbox. There is a tutorial on the PyMVPA website for how to implement different versions of hyperalignment. The Shared Response Model was developed at Princeton University and is implemented in the brainiak toolbox and I also encourage you to see their excellent tutorial.</p>

<h2 id="reponse-based-hyperalignment">Reponse-based Hyperalignment</h2>
<p>Functional alignment is usually performed within an ROI. The original hyperalignment papers align within searchlights over the whole brain. 
Here, we will align within regions of interest (ROI) from whole-brain functional parcellations. We will use a n=50 parcellation based on patterns of coactivation from the Neurosynth database (de la Vega et al.,2016)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ROI mask
</span><span class="n">mask</span> <span class="o">=</span> <span class="nc">Brain_Data</span><span class="p">(</span><span class="sh">'</span><span class="s">https://neurovault.org/media/images/8423/k50_2mm.nii.gz</span><span class="sh">'</span><span class="p">)</span>
<span class="n">mask_x</span> <span class="o">=</span> <span class="nf">expand_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
<span class="n">mask</span><span class="p">.</span><span class="nf">plot</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/img/fa/Functional%20Alignment_6_0.png" alt="png" width="100%"></p>

<p>As an example, letâ€™s extract voxel activity within the early visual cortex (i.e. ROI 4) from the second half of Sherlock (i.e. Part2) using hdf5 files.
Brain_Data class of nltools loads data.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example of single ROI
</span><span class="n">scan</span> <span class="o">=</span> <span class="sh">'</span><span class="s">Part2</span><span class="sh">'</span>
<span class="n">roi</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">roi_mask</span> <span class="o">=</span> <span class="n">mask_x</span><span class="p">[</span><span class="n">roi</span><span class="p">]</span>

<span class="n">file_list</span> <span class="o">=</span> <span class="n">glob</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="sh">'</span><span class="s">fmriprep</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">*</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">func</span><span class="sh">'</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="s">*crop*</span><span class="si">{</span><span class="n">scan</span><span class="si">}</span><span class="s">*hdf5</span><span class="sh">'</span><span class="p">))</span>
<span class="n">all_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
    <span class="n">sub</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">f</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">_</span><span class="sh">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nc">Brain_Data</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">all_data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">apply_mask</span><span class="p">(</span><span class="n">roi_mask</span><span class="p">))</span>
    
<span class="n">roi_mask</span><span class="p">.</span><span class="nf">plot</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sub-13
sub-14
sub-15
sub-12
sub-08
sub-01
sub-06
sub-07
sub-09
sub-10
sub-11
sub-16
sub-05
sub-02
sub-03
sub-04
</code></pre></div></div>

<p><img src="/assets/img/fa/Functional%20Alignment_8_1.png" alt="png" width="100%"></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Hyperalignment using procrustes transform
# align() input is a list of Brain_Data objects (numpy matrices)
</span>
<span class="c1"># Here, we will exclude the last subject for now and add them later in the tutorial.
</span>
<span class="c1"># align() output is dictionary with keys for a list of...
# 'transformed': transformed data, 
# 'transformation_matrix': corresponding transformation matrices, 
# 'common_model': the common model where all subjects are projected
# 'isc': Intersubject Correlations(ISC) for transformed data
# 'disparity': multivariate distance of the subject to common space
# 'scale' ?
</span>
<span class="n">hyperalign</span> <span class="o">=</span> <span class="nf">align</span><span class="p">(</span><span class="n">all_data</span><span class="p">[:</span><span class="mi">15</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="sh">'</span><span class="s">procrustes</span><span class="sh">'</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="n">hyperalign</span><span class="p">.</span><span class="nf">keys</span><span class="p">())</span>
</code></pre></div></div>

<p>Letâ€™s plot the aligned voxel time course.
We will see how similar the activity is across participants within a random voxel using ISC.
ISC is the average pairwise correlation between subject voxel time courses.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">voxel_index</span> <span class="o">=</span> <span class="mi">50</span>

<span class="n">voxel_unaligned</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">([</span><span class="n">x</span><span class="p">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">voxel_index</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">all_data</span><span class="p">]).</span><span class="n">T</span>
<span class="n">voxel_aligned</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">([</span><span class="n">x</span><span class="p">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">voxel_index</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hyperalign</span><span class="p">[</span><span class="sh">'</span><span class="s">transformed</span><span class="sh">'</span><span class="p">]]).</span><span class="n">T</span>

<span class="n">f</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">voxel_unaligned</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">-</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">voxel_unaligned</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">-</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">navy</span><span class="sh">'</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Unaligned Voxel</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">yaxis</span><span class="p">.</span><span class="nf">set_ticks</span><span class="p">([])</span>

<span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">voxel_aligned</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">-</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">voxel_aligned</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">-</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">navy</span><span class="sh">'</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Aligned Voxel</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">yaxis</span><span class="p">.</span><span class="nf">set_ticks</span><span class="p">([])</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Voxel Time Course (TRs)</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unaligned Voxel ISC: r=</span><span class="si">{</span><span class="nc">Adjacency</span><span class="p">(</span><span class="n">voxel_unaligned</span><span class="p">.</span><span class="nf">corr</span><span class="p">(),</span> <span class="n">matrix_type</span><span class="o">=</span><span class="sh">'</span><span class="s">similarity</span><span class="sh">'</span><span class="p">).</span><span class="nf">mean</span><span class="p">()</span><span class="si">:</span><span class="p">.</span><span class="mi">02</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Aligned Voxel ISC: r=</span><span class="si">{</span><span class="nc">Adjacency</span><span class="p">(</span><span class="n">voxel_aligned</span><span class="p">.</span><span class="nf">corr</span><span class="p">(),</span> <span class="n">matrix_type</span><span class="o">=</span><span class="sh">'</span><span class="s">similarity</span><span class="sh">'</span><span class="p">).</span><span class="nf">mean</span><span class="p">()</span><span class="si">:</span><span class="p">.</span><span class="mi">02</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Text(0.5, 1.0, 'Aligned Voxel ISC: r=0.4')
</code></pre></div></div>

<p><img src="/assets/img/fa/Functional%20Alignment_11_1.png" alt="png" width="100%"></p>

<p>The overall time course of both unaligned and aligned voxel activity is very similar.
However, participants have an overall higher degree of similarity after hyperalignment (r=0.4) compared to the unaligned data (r=0.34).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Plot the distribution of overall ISC across all voxels
</span><span class="n">plt</span><span class="p">.</span><span class="nf">hist</span><span class="p">(</span><span class="n">hyperalign</span><span class="p">[</span><span class="sh">'</span><span class="s">isc</span><span class="sh">'</span><span class="p">].</span><span class="nf">values</span><span class="p">())</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">hyperalign</span><span class="p">[</span><span class="sh">'</span><span class="s">isc</span><span class="sh">'</span><span class="p">].</span><span class="nf">values</span><span class="p">())),</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">--</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Frequency</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Voxel ISC Values</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">Hyperalignment ISC</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Mean ISC: </span><span class="si">{</span><span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">hyperalign</span><span class="p">[</span><span class="sh">'</span><span class="s">isc</span><span class="sh">'</span><span class="p">].</span><span class="nf">values</span><span class="p">()))</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Mean ISC: 0.36
</code></pre></div></div>

<p><img src="/assets/img/fa/Functional%20Alignment_13_1.png" alt="png" width="100%"></p>

<p>The overall ISC across voxels is pretty high, mean=0.36.
Note that the mean ISC value is biased b/c itâ€™s not cross-validated so itâ€™s likely slightly inflated.</p>

<p>Letâ€™s plot the transformed data for a random TR and check the impact of hyperalignment on spatial topography.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tr_index</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">f</span><span class="p">,</span><span class="n">a</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">sns</span><span class="p">.</span><span class="nf">heatmap</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">rot90</span><span class="p">(</span><span class="n">all_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">tr_index</span><span class="p">].</span><span class="nf">to_nifti</span><span class="p">().</span><span class="n">dataobj</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="mi">60</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span><span class="mi">28</span><span class="p">,</span> <span class="mi">37</span><span class="p">]),</span> <span class="n">cbar</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">RdBu_r</span><span class="sh">'</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
    <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">Subject: </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
    <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">].</span><span class="n">axes</span><span class="p">.</span><span class="nf">get_xaxis</span><span class="p">().</span><span class="nf">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">].</span><span class="n">yaxis</span><span class="p">.</span><span class="nf">set_ticks</span><span class="p">([])</span>
    <span class="n">sns</span><span class="p">.</span><span class="nf">heatmap</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">rot90</span><span class="p">(</span><span class="n">hyperalign</span><span class="p">[</span><span class="sh">'</span><span class="s">transformed</span><span class="sh">'</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">tr_index</span><span class="p">].</span><span class="nf">to_nifti</span><span class="p">().</span><span class="n">dataobj</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="mi">60</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span><span class="mi">28</span><span class="p">,</span> <span class="mi">37</span><span class="p">]),</span> <span class="n">cbar</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">RdBu_r</span><span class="sh">'</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
    <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">].</span><span class="n">axes</span><span class="p">.</span><span class="nf">get_xaxis</span><span class="p">().</span><span class="nf">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">].</span><span class="n">yaxis</span><span class="p">.</span><span class="nf">set_ticks</span><span class="p">([])</span>

<span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Unaligned Voxels</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Aligned Voxels</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/img/fa/Functional%20Alignment_16_0.png" alt="png" width="100%"></p>

<p>Are the subjectsâ€™ patterns more spatially similar after alignment? With alignment, voxels are rearranged to maximize temporal synchrony. The algorithm picks a random subject and then projects every other subject into that space. This is averaged and then iteratively repeated.</p>

<h2 id="shared-response-model">Shared Response Model</h2>
<p>This model allows alignment into a lower dimensional functional space, rather than dimension size of the number of voxels (which can be alot).
This model learns a common latent space and the overall dimensionality is limited to the number of observations.
In this example, there are more voxels (n=2786) in the early visual anatomical mask relative to the number of observed TRs (n=1030). This means the max number of components we can estimate is 1030.
Here, we will align to a 100 dimensional feature space.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># zscore the data and then train model with SRM
</span><span class="n">all_data_z</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">.</span><span class="nf">standardize</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="sh">'</span><span class="s">zscore</span><span class="sh">'</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">all_data</span><span class="p">]</span>
<span class="n">srm</span> <span class="o">=</span> <span class="nf">align</span><span class="p">(</span><span class="n">all_data_z</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="sh">'</span><span class="s">deterministic_srm</span><span class="sh">'</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Plot the average time course of a single latent component
# But we cannot directly compare SRMs to the unaligned voxels (unlike the examples above)
</span>
<span class="n">component_index</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">component_aligned</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">([</span><span class="n">x</span><span class="p">[:,</span> <span class="n">component_index</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">srm</span><span class="p">[</span><span class="sh">'</span><span class="s">transformed</span><span class="sh">'</span><span class="p">]]).</span><span class="n">T</span>

<span class="n">f</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">a</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">component_aligned</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">-</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span>
<span class="n">a</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">component_aligned</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">-</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">navy</span><span class="sh">'</span><span class="p">)</span>
<span class="n">a</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Aligned Component</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">a</span><span class="p">.</span><span class="n">yaxis</span><span class="p">.</span><span class="nf">set_ticks</span><span class="p">([])</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Component Time Course (TRs)</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">a</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Aligned Component ISC: r=</span><span class="si">{</span><span class="nc">Adjacency</span><span class="p">(</span><span class="n">component_aligned</span><span class="p">.</span><span class="nf">corr</span><span class="p">(),</span> <span class="n">matrix_type</span><span class="o">=</span><span class="sh">'</span><span class="s">similarity</span><span class="sh">'</span><span class="p">).</span><span class="nf">mean</span><span class="p">()</span><span class="si">:</span><span class="p">.</span><span class="mi">02</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Text(0.5, 1.0, 'Aligned Component ISC: r=0.45')
</code></pre></div></div>

<p><img src="/assets/img/fa/Functional%20Alignment_20_1.png" alt="png" width="100%"></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Plot the distribution of overall ISC across all components
</span><span class="n">plt</span><span class="p">.</span><span class="nf">hist</span><span class="p">(</span><span class="n">srm</span><span class="p">[</span><span class="sh">'</span><span class="s">isc</span><span class="sh">'</span><span class="p">].</span><span class="nf">values</span><span class="p">())</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">srm</span><span class="p">[</span><span class="sh">'</span><span class="s">isc</span><span class="sh">'</span><span class="p">].</span><span class="nf">values</span><span class="p">())),</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">--</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Frequency</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Voxel ISC Values</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">Shared Response Model ISC</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Text(0.5, 1.0, 'Shared Response Model ISC')
</code></pre></div></div>

<p><img src="/assets/img/fa/Functional%20Alignment_21_1.png" alt="png" width="100%"></p>

<p>The consequence of this lower dimensional projection is that we can no longer maintain a voxel level representation. So we are unable to generate the same figure depicting how the cortical topographies change.
Instead, we will plot the weights that project each subjectâ€™s data into a common latent time course.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Plot spatial pattern of weights that project subject data into a random latent component (time course)
</span><span class="n">component</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">constrained_layout</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">spec</span> <span class="o">=</span> <span class="n">gridspec</span><span class="p">.</span><span class="nc">GridSpec</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">a0</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">a0</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">rot90</span><span class="p">(</span><span class="n">srm</span><span class="p">[</span><span class="sh">'</span><span class="s">transformation_matrix</span><span class="sh">'</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">component</span><span class="p">].</span><span class="nf">to_nifti</span><span class="p">().</span><span class="n">dataobj</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="mi">60</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span><span class="mi">28</span><span class="p">,</span> <span class="mi">37</span><span class="p">]),</span><span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">RdBu_r</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">a0</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">Subject </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
    <span class="n">a0</span><span class="p">.</span><span class="n">yaxis</span><span class="p">.</span><span class="nf">set_ticks</span><span class="p">([])</span>
    <span class="n">a0</span><span class="p">.</span><span class="n">xaxis</span><span class="p">.</span><span class="nf">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>    
    
    <span class="n">a1</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">:])</span>
    <span class="n">a1</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">srm</span><span class="p">[</span><span class="sh">'</span><span class="s">transformed</span><span class="sh">'</span><span class="p">][</span><span class="n">i</span><span class="p">][:,</span><span class="n">component</span><span class="p">])</span>
    <span class="n">a1</span><span class="p">.</span><span class="n">xaxis</span><span class="p">.</span><span class="nf">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">a1</span><span class="p">.</span><span class="n">yaxis</span><span class="p">.</span><span class="nf">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">a0</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Spatial Pattern</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">a1</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Latent Timecourse</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/assets/img/fa/Functional%20Alignment_23_0.png" alt="png" width="100%"></p>

<h2 id="project-new-subject-data-into-common-space">Project New Subject Data into Common Space</h2>
<p>We can align new subjects into the common model without retraining the entire model.
Here, we individually align subject 16 to the common space learned above using hyperalignment.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Align the leftout subject data to common model
</span><span class="n">new_data</span> <span class="o">=</span> <span class="n">all_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="n">new_data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">plot</span><span class="p">()</span>

<span class="n">aligned_sub_hyperalignment</span> <span class="o">=</span> <span class="n">new_data</span><span class="p">.</span><span class="nf">align</span><span class="p">(</span><span class="n">hyperalign</span><span class="p">[</span><span class="sh">'</span><span class="s">common_model</span><span class="sh">'</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="sh">'</span><span class="s">procrustes</span><span class="sh">'</span><span class="p">)</span>

<span class="n">aligned_sub_hyperalignment</span><span class="p">[</span><span class="sh">'</span><span class="s">transformed</span><span class="sh">'</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nf">plot</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/img/fa/Functional%20Alignment_25_0.png" alt="png" width="100%"></p>

<p><img src="/assets/img/fa/Functional%20Alignment_25_1.png" alt="png" width="100%"></p>

<p>The pattern of cortical activation has now changed after projecting this subject into the common space.</p>

<p>We can also project subject 16 into the SRM common space. Note that we also need to zscore the subjectâ€™s data before alignment.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">aligned_sub_srm</span> <span class="o">=</span> <span class="n">new_data</span><span class="p">.</span><span class="nf">standardize</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="sh">'</span><span class="s">zscore</span><span class="sh">'</span><span class="p">).</span><span class="nf">align</span><span class="p">(</span><span class="n">srm</span><span class="p">[</span><span class="sh">'</span><span class="s">common_model</span><span class="sh">'</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="sh">'</span><span class="s">deterministic_srm</span><span class="sh">'</span><span class="p">)</span>

<span class="n">aligned_sub_srm</span><span class="p">[</span><span class="sh">'</span><span class="s">transformation_matrix</span><span class="sh">'</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nf">plot</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/img/fa/Functional%20Alignment_27_0.png" alt="png" width="100%"></p>

<p>Because the FA models were trained to maximize ISC, the ISC values are biased and will likely be inflated.
It is important to evaluate how well the model works on independent data.
You can either divide data into training and test datasets, or perform cross-validation.</p>

<p>The idea is to use the LEARNED subject-specific transformation matrices to project NEW independent data from that participant into the common space.</p>

<p>Here we will project Part1 Sherlock data into common space using models trained on Part2 data.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Load Part1 data and overwrite Part2 data to save RAM
</span><span class="n">scan</span> <span class="o">=</span> <span class="sh">'</span><span class="s">Part1</span><span class="sh">'</span>
<span class="n">roi</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">roi_mask</span> <span class="o">=</span> <span class="n">mask_x</span><span class="p">[</span><span class="n">roi</span><span class="p">]</span>

<span class="n">file_list</span> <span class="o">=</span> <span class="n">glob</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="sh">'</span><span class="s">fmriprep</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">*</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">func</span><span class="sh">'</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="s">*crop*</span><span class="si">{</span><span class="n">scan</span><span class="si">}</span><span class="s">*hdf5</span><span class="sh">'</span><span class="p">))</span>
<span class="n">all_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
    <span class="n">sub</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">f</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">_</span><span class="sh">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nc">Brain_Data</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">all_data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">apply_mask</span><span class="p">(</span><span class="n">roi_mask</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sub-13
sub-14
sub-15
sub-12
sub-08
sub-01
sub-06
sub-07
sub-09
sub-10
sub-11
sub-16
sub-05
sub-02
sub-03
sub-04
</code></pre></div></div>

<p>Project data into the common space using hyperalignment.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create a copy of subject 16's data variable
</span><span class="n">s16_pt1_hyp_transformed</span> <span class="o">=</span> <span class="n">all_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">copy</span><span class="p">()</span>

<span class="c1"># Use np.dot() to perform a simple inner matrix multiplication to project the data into common space 
# using the subject's transformation matrix learned from Part2
</span><span class="n">s16_pt1_hyp_transformed</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">s16_pt1_hyp_transformed</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">aligned_sub_hyperalignment</span><span class="p">[</span><span class="sh">'</span><span class="s">transformation_matrix</span><span class="sh">'</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">T</span><span class="p">)</span>

<span class="n">s16_pt1_hyp_transformed</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nltools.data.brain_data.Brain_Data(data=(946, 2786), Y=0, X=(0, 0), mask=MNI152_T1_2mm_brain_mask.nii.gz)
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Repeat for the rest of the participants
</span>
<span class="n">hyperalign_transformed</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">all_data</span><span class="p">[:</span><span class="mi">15</span><span class="p">]):</span>
    <span class="n">new_x</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
    <span class="n">new_x</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">hyperalign</span><span class="p">[</span><span class="sh">'</span><span class="s">transformation_matrix</span><span class="sh">'</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">hyperalign_transformed</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">new_x</span><span class="p">)</span>
</code></pre></div></div>

<p>This time, project data into the common space using SRM. Remember to zscore the data again.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">s16_pt1_srm_transformed</span> <span class="o">=</span> <span class="n">all_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">copy</span><span class="p">().</span><span class="nf">standardize</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="sh">'</span><span class="s">zscore</span><span class="sh">'</span><span class="p">)</span>

<span class="n">s16_pt1_srm_transformed</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">s16_pt1_srm_transformed</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">aligned_sub_srm</span><span class="p">[</span><span class="sh">'</span><span class="s">transformation_matrix</span><span class="sh">'</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">T</span><span class="p">)</span>

<span class="n">s16_pt1_srm_transformed</span><span class="p">.</span><span class="n">shape</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(946, 100)
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Repeat for the rest of the participants
</span>
<span class="n">srm_transformed</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">all_data</span><span class="p">[:</span><span class="mi">15</span><span class="p">]):</span>
    <span class="n">srm_transformed</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="nf">standardize</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="sh">'</span><span class="s">zscore</span><span class="sh">'</span><span class="p">).</span><span class="n">data</span><span class="p">,</span> <span class="n">srm</span><span class="p">[</span><span class="sh">'</span><span class="s">transformation_matrix</span><span class="sh">'</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">T</span><span class="p">))</span>
</code></pre></div></div>

  </article>

</div>

    </div>

    <!-- Footer -->    
    <footer class="fixed-bottom">
      <div class="container mt-0">
        Â© Copyright 2023 Naeun  Oh. Powered by <a href="http://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" target="_blank" rel="noopener noreferrer">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="noopener noreferrer">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="noopener noreferrer">Unsplash</a>.

      </div>
    </footer>

    <!-- JavaScripts -->
    <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <!-- Bootsrap & MDB scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.2/dist/umd/popper.min.js" integrity="sha256-l/1pMF/+J4TThfgARS6KwWrk/egwuVvhRzfLAMQ6Ds4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js" integrity="sha256-SyTu6CwrfOhaznYZPoolVw2rxoY7lKYKQvqbtqN93HI=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script>

    <!-- Mansory & imagesLoaded -->
  <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
  <script defer src="/assets/js/mansory.js" type="text/javascript"></script>
    
  <!-- Medium Zoom JS -->
  <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
  <script src="/assets/js/zoom.js"></script><!-- Load Common JS -->
  <script src="/assets/js/common.js"></script>

    <!-- MathJax -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        tags: 'ams'
      }
    };
  </script>
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
  <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    
  </body>
</html>

