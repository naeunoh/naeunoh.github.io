<!DOCTYPE html>
<html lang="en">

  <!-- Head -->
  <head>        
    <!-- Metadata, OpenGraph and Schema.org -->
    

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Naeun  Oh | Intersubject Correlation Notebook</title>
    <meta name="author" content="Naeun  Oh" />
    <meta name="description" content="tutorial for intersubject correlation" />
    <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website" />


    <!-- Bootstrap & MDB -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous" />

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

    <!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://gitcdn.link/repo/jwarby/jekyll-pygments-themes/master/github.css" />

    <!-- Styles -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ”¥</text></svg>">
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="https://naeunoh.github.io/blog/2022/intersubject-correlation-code/">

    <!-- Dark Mode -->
    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/dark_mode.js"></script>
  </head>

  <!-- Body -->
  <body class="fixed-top-nav">

    <!-- Header -->
    <header>

      <!-- Nav Bar -->
      <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
        <div class="container">
          <a class="navbar-brand title font-weight-lighter" href="https://naeunoh.github.io/"><span class="font-weight-bold">Naeun</span>   Oh</a>
          <!-- Navbar Toggle -->
          <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar top-bar"></span>
            <span class="icon-bar middle-bar"></span>
            <span class="icon-bar bottom-bar"></span>
          </button>

          <div class="collapse navbar-collapse text-right" id="navbarNav">
            <ul class="navbar-nav ml-auto flex-nowrap">

              <!-- About -->
              <li class="nav-item ">
                <a class="nav-link" href="/">about</a>
              </li>
              
              <!-- Blog -->
              <li class="nav-item active">
                <a class="nav-link" href="/blog/">blog</a>
              </li>

              <!-- Other pages -->
              <li class="nav-item ">
                <a class="nav-link" href="/projects/">projects</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/publications/">publications</a>
              </li>
              <li class="nav-item dropdown ">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus</a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="/publications/">publications</a>
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" href="/projects/">projects</a>
                </div>
              </li>

              <!-- Toogle theme mode -->
              <div class="toggle-container">
                <a id="light-toggle">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
                </a>
              </div>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <!-- Content -->
    <div class="container mt-5">
      <!-- _layouts/post.html -->

<div class="post">

  <header class="post-header">
    <h1 class="post-title">Intersubject Correlation Notebook</h1>
    <p class="post-meta">July 17, 2022</p>
    <p class="post-tags">
      <a href="/blog/2022"> <i class="fas fa-calendar fa-sm"></i> 2022 </a>
      Â  Â· Â 
        <a href="/blog/tag/neuroimaging">
          <i class="fas fa-hashtag fa-sm"></i> neuroimaging</a> Â 
          <a href="/blog/tag/psychology">
          <i class="fas fa-hashtag fa-sm"></i> psychology</a> Â 
          <a href="/blog/tag/analysis-methods">
          <i class="fas fa-hashtag fa-sm"></i> analysis-methods</a> Â 
          
      Â  Â· Â 
        <a href="/blog/category/naturalistic-data-analysis">
          <i class="fas fa-tag fa-sm"></i> naturalistic-data-analysis</a> Â 
          

    </p>
  </header>

  <article class="post-content">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>

<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">numpy.fft</span> <span class="kn">import</span> <span class="n">fft</span><span class="p">,</span> <span class="n">ifft</span><span class="p">,</span> <span class="n">fftfreq</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="n">matplotlib</span> <span class="kn">import</span> <span class="n">gridspec</span>
<span class="kn">from</span> <span class="n">matplotlib.animation</span> <span class="kn">import</span> <span class="n">FuncAnimation</span>
<span class="kn">import</span> <span class="n">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="kn">from</span> <span class="n">nltools.data</span> <span class="kn">import</span> <span class="n">Brain_Data</span><span class="p">,</span> <span class="n">Adjacency</span>
<span class="kn">from</span> <span class="n">nltools.mask</span> <span class="kn">import</span> <span class="n">expand_mask</span><span class="p">,</span> <span class="n">roi_to_brain</span>
<span class="kn">from</span> <span class="n">nltools.stats</span> <span class="kn">import</span> <span class="n">isc</span><span class="p">,</span> <span class="n">isfc</span><span class="p">,</span> <span class="n">isps</span><span class="p">,</span> <span class="n">fdr</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">phase_randomize</span><span class="p">,</span> <span class="n">circle_shift</span><span class="p">,</span> <span class="n">_butter_bandpass_filter</span><span class="p">,</span> <span class="n">_phase_mean_angle</span><span class="p">,</span> <span class="n">_phase_vector_length</span>
<span class="kn">from</span> <span class="n">nilearn.plotting</span> <span class="kn">import</span> <span class="n">view_img_on_surf</span><span class="p">,</span> <span class="n">view_img</span>
<span class="kn">from</span> <span class="n">sklearn.metrics</span> <span class="kn">import</span> <span class="n">pairwise_distances</span>
<span class="kn">from</span> <span class="n">sklearn.utils</span> <span class="kn">import</span> <span class="n">check_random_state</span>
<span class="kn">from</span> <span class="n">scipy.stats</span> <span class="kn">import</span> <span class="n">ttest_1samp</span>
<span class="kn">from</span> <span class="n">scipy.signal</span> <span class="kn">import</span> <span class="n">hilbert</span>
<span class="kn">import</span> <span class="n">networkx</span> <span class="k">as</span> <span class="n">nx</span>
<span class="kn">from</span> <span class="n">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span>
<span class="kn">import</span> <span class="n">warnings</span>
<span class="kn">import</span> <span class="n">brainiak.isc</span>

<span class="c1"># import nest_asyncio
# nest_asyncio.apply()
</span><span class="kn">import</span> <span class="n">datalad.api</span> <span class="k">as</span> <span class="n">dl</span>

<span class="n">warnings</span><span class="p">.</span><span class="nf">simplefilter</span><span class="p">(</span><span class="sh">'</span><span class="s">ignore</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="get-dataset-using-datalad">Get Dataset using datalad</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data_dir</span> <span class="o">=</span> <span class="sh">'</span><span class="s">/Users/naeun-oh/Sherlock</span><span class="sh">'</span>

<span class="c1"># If dataset hasn't been installed, clone from GIN repository
</span><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
    <span class="n">dl</span><span class="p">.</span><span class="nf">clone</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="sh">'</span><span class="s">https://gin.g-node.org/ljchang/Sherlock</span><span class="sh">'</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">data_dir</span><span class="p">)</span>

<span class="c1"># Initialize dataset
</span><span class="n">ds</span> <span class="o">=</span> <span class="n">dl</span><span class="p">.</span><span class="nc">Dataset</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>

<span class="n">ds</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">annex</span><span class="o">=</span><span class="sh">'</span><span class="s">all</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="intersubject-correlation">Intersubject Correlation</h2>
<p>We will compute ISC on average activity within 50 ROIs, which is already extracted in csv files for all participants.
We will use the pairwise method to compute ISC for each ROI.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Get Cropped &amp; Denoised CSV Files
</span><span class="n">result</span> <span class="o">=</span> <span class="n">ds</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">glob</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="sh">'</span><span class="s">fmriprep</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">*</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">func</span><span class="sh">'</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="s">*Average_ROI*csv</span><span class="sh">'</span><span class="p">)))</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ROI mask : 
# download the k=50 whole brain meta-analytic parcellation of the neurosynth database (de la Vega, 2016) from neurovault
</span><span class="n">mask</span> <span class="o">=</span> <span class="nc">Brain_Data</span><span class="p">(</span><span class="sh">'</span><span class="s">http://neurovault.org/media/images/2099/Neurosynth%20Parcellation_0.nii.gz</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Each ROI is indicated with a unique integer
# The whole mask is expanded into 50 separate binary masks with expand_mask()
</span><span class="n">mask_x</span> <span class="o">=</span> <span class="nf">expand_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

<span class="n">mask</span><span class="p">.</span><span class="nf">plot</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/img/isc/Intersubject%20Correlation_5_0.png" alt="png" width="100%"></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># You can practice extracting average ROI data but it's been done for you already
</span><span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">'</span><span class="s">Part1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Part2</span><span class="sh">'</span><span class="p">]:</span>
    <span class="n">file_list</span> <span class="o">=</span> <span class="n">glob</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="sh">'</span><span class="s">fmriprep</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">*</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">func</span><span class="sh">'</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="s">*crop*</span><span class="si">{</span><span class="n">scan</span><span class="si">}</span><span class="s">*hdf5</span><span class="sh">'</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">f</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">_</span><span class="sh">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nc">Brain_Data</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">roi</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">extract_roi</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">roi</span><span class="p">.</span><span class="n">T</span><span class="p">).</span><span class="nf">to_csv</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">scan</span><span class="si">}</span><span class="s">_Average_ROI_n50.csv</span><span class="sh">"</span> <span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Load the csv files for each participant and save into dict
</span><span class="n">sub_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">_</span><span class="sh">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="sh">'</span><span class="s">fmriprep</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">*</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">func</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">*Part1*csv</span><span class="sh">'</span><span class="p">))]</span>
<span class="n">sub_list</span><span class="p">.</span><span class="nf">sort</span><span class="p">()</span>

<span class="n">sub_timeseries</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">sub_list</span><span class="p">:</span>
    <span class="n">part1</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="sh">'</span><span class="s">fmriprep</span><span class="sh">'</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="sh">'</span><span class="s">func</span><span class="sh">'</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s">_Part1_Average_ROI_n50.csv</span><span class="sh">'</span><span class="p">))</span>
    <span class="n">part2</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="sh">'</span><span class="s">fmriprep</span><span class="sh">'</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="sh">'</span><span class="s">func</span><span class="sh">'</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s">_Part2_Average_ROI_n50.csv</span><span class="sh">'</span><span class="p">))</span>
    <span class="n">sub_data</span> <span class="o">=</span> <span class="n">part1</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">part2</span><span class="p">)</span>
    <span class="n">sub_data</span><span class="p">.</span><span class="nf">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">sub_timeseries</span><span class="p">[</span><span class="n">sub</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_data</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create new pandas DataFrame that has average vmPFC activity for each participant
</span><span class="n">roi</span> <span class="o">=</span> <span class="mi">32</span>

<span class="n">mask_x</span><span class="p">[</span><span class="n">roi</span><span class="p">].</span><span class="nf">plot</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">get_subject_roi</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">roi</span><span class="p">):</span>
    <span class="n">sub_rois</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">sub_rois</span><span class="p">[</span><span class="n">sub</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">sub</span><span class="p">].</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">roi</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">sub_rois</span><span class="p">)</span>

<span class="n">sub_rois</span> <span class="o">=</span> <span class="nf">get_subject_roi</span><span class="p">(</span><span class="n">sub_timeseries</span><span class="p">,</span> <span class="n">roi</span><span class="p">)</span>
<span class="n">sub_rois</span><span class="p">.</span><span class="nf">head</span><span class="p">()</span>
<span class="c1"># sub_rois size: voxels x subjects
</span></code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
    .dataframe table {
        width:100%; 
        overflow:auto
    }
</style>
<table border="1" class="dataframe">

  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sub-01</th>
      <th>sub-02</th>
      <th>sub-03</th>
      <th>sub-04</th>
      <th>sub-05</th>
      <th>sub-06</th>
      <th>sub-07</th>
      <th>sub-08</th>
      <th>sub-09</th>
      <th>sub-10</th>
      <th>sub-11</th>
      <th>sub-12</th>
      <th>sub-13</th>
      <th>sub-14</th>
      <th>sub-15</th>
      <th>sub-16</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3.362605</td>
      <td>-1.967253</td>
      <td>-0.243505</td>
      <td>2.527032</td>
      <td>5.166227</td>
      <td>-0.678549</td>
      <td>2.199253</td>
      <td>-1.646883e+00</td>
      <td>0.421235</td>
      <td>0.500547</td>
      <td>0.361623</td>
      <td>4.639737e+00</td>
      <td>1.490442</td>
      <td>1.806639</td>
      <td>1.039467</td>
      <td>3.483579e-13</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.995695</td>
      <td>1.730923</td>
      <td>1.552836</td>
      <td>1.068784</td>
      <td>4.066954</td>
      <td>0.117737</td>
      <td>3.184899</td>
      <td>8.464993e-01</td>
      <td>-0.118011</td>
      <td>0.981400</td>
      <td>-0.069505</td>
      <td>2.522244e+00</td>
      <td>1.145760</td>
      <td>-0.582861</td>
      <td>-0.420722</td>
      <td>-1.237187e-13</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2.084567</td>
      <td>-1.940155</td>
      <td>1.914897</td>
      <td>1.103097</td>
      <td>2.168681</td>
      <td>0.030628</td>
      <td>2.036096</td>
      <td>1.782011e-01</td>
      <td>0.984125</td>
      <td>3.957482</td>
      <td>-0.792416</td>
      <td>1.326291e+00</td>
      <td>0.472309</td>
      <td>-3.066318</td>
      <td>0.869296</td>
      <td>-1.931528e-02</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-0.217049</td>
      <td>-0.636084</td>
      <td>1.501459</td>
      <td>-0.701397</td>
      <td>1.704406</td>
      <td>0.042397</td>
      <td>2.353035</td>
      <td>1.088203e+00</td>
      <td>1.650786</td>
      <td>3.687806</td>
      <td>3.839885</td>
      <td>2.105321e-02</td>
      <td>-2.885314</td>
      <td>-1.212683</td>
      <td>1.213115</td>
      <td>-1.460159e+00</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-2.628723</td>
      <td>1.650023</td>
      <td>-1.196258</td>
      <td>0.079026</td>
      <td>1.297944</td>
      <td>-0.743593</td>
      <td>1.188282</td>
      <td>3.375227e-13</td>
      <td>1.515944</td>
      <td>-0.709527</td>
      <td>4.874887</td>
      <td>2.279356e-13</td>
      <td>-5.277045</td>
      <td>0.232831</td>
      <td>1.914874</td>
      <td>1.745742e+00</td>
    </tr>
  </tbody>
</table>
</div>

<p><img src="/assets/img/isc/Intersubject%20Correlation_8_1.png" alt="png" width="100%"></p>

<h2 id="hypothesis-testing-on-isc">Hypothesis Testing on ISC</h2>
<p>To perform ISC we will use nltools.stats.isc()
To perform hypothesis tests, we will implement three different non-parametric methods: circular shifting data, phase randomization, subject-wise bootstrap</p>

<h3 id="circular-shifting">Circular Shifting</h3>
<p>First, the idea behind circular shifting data is to generate random surrogate data that has the same autoregressive and temporal properties of the original data (Lancaster et al., 2018). This involves randomly selecting a time point to become the new beginning of the timeseries and then concatenating the rest of the data at the end so that it has the same length as the original data. Of course, there wil potentially be a sudden change in the data where the two parts were merged.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Plot one subject's time series and shift it using nltools.stats.circle_shift()
# Plot the coefficients from a fast fourier transform (shows frequency)
</span><span class="n">sub</span> <span class="o">=</span> <span class="sh">'</span><span class="s">sub-02</span><span class="sh">'</span>
<span class="n">sampling_freq</span> <span class="o">=</span> <span class="p">.</span><span class="mi">5</span>

<span class="n">f</span><span class="p">,</span><span class="n">a</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">sub_rois</span><span class="p">[</span><span class="n">sub</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Avg Activity</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Time (TR)</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Observed Data</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

<span class="n">fft_data</span> <span class="o">=</span> <span class="nf">fft</span><span class="p">(</span><span class="n">sub_rois</span><span class="p">[</span><span class="n">sub</span><span class="p">])</span>
<span class="n">freq</span> <span class="o">=</span> <span class="nf">fftfreq</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">fft_data</span><span class="p">),</span> <span class="mi">1</span><span class="o">/</span><span class="n">sampling_freq</span><span class="p">)</span>
<span class="n">n_freq</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">floor</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">fft_data</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
<span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">freq</span><span class="p">[:</span><span class="n">n_freq</span><span class="p">],</span> <span class="n">np</span><span class="p">.</span><span class="nf">abs</span><span class="p">(</span><span class="n">fft_data</span><span class="p">)[:</span><span class="n">n_freq</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Frequency (Hz)</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Amplitude</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Power Spectrum</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="n">circle_shift_data</span> <span class="o">=</span> <span class="nf">circle_shift</span><span class="p">(</span><span class="n">sub_rois</span><span class="p">[</span><span class="n">sub</span><span class="p">])</span>
<span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">circle_shift_data</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Avg Activity</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Time (TR)</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Circle Shifted Data</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

<span class="n">fft_circle</span> <span class="o">=</span> <span class="nf">fft</span><span class="p">(</span><span class="n">circle_shift_data</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">freq</span><span class="p">[:</span><span class="n">n_freq</span><span class="p">],</span> <span class="n">np</span><span class="p">.</span><span class="nf">abs</span><span class="p">(</span><span class="n">fft_circle</span><span class="p">)[:</span><span class="n">n_freq</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Frequency (Hz)</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Amplitude</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Circle Shifted Power Spectrum</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/img/isc/Intersubject%20Correlation_11_0.png" alt="png" width="100%"></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Compute ISC of vmPFC roi with 5000 permutations.
# isc() outputs a dictionary that contains ISC values, p-value, 95% confidence intervals, optimally returns 5000 samples
# parallel run
</span><span class="n">stats_circle</span> <span class="o">=</span> <span class="nf">isc</span><span class="p">(</span><span class="n">sub_rois</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="sh">'</span><span class="s">circle_shift</span><span class="sh">'</span><span class="p">,</span> <span class="n">n_bootstraps</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">return_bootstraps</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ISC: </span><span class="si">{</span><span class="n">stats_circle</span><span class="p">[</span><span class="sh">'</span><span class="s">isc</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">02</span><span class="si">}</span><span class="s">, p = </span><span class="si">{</span><span class="n">stats_circle</span><span class="p">[</span><span class="sh">'</span><span class="s">p</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">03</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ISC: 0.074, p = 0.0002
</code></pre></div></div>

<h3 id="phase-randomization">Phase Randomization</h3>
<p>Second, phase randomization projects the data into frequency space using a fast fourier transform, preserves the Fourier amplitudes but randomizes the Fourier phases(angle representing the fraction of the cycle covered, e.g. 90deg), and then projects the data back into the time domain (Theiler et al., 1992, Lancaster et al., 2018). Similar to the circular shifting method, this generates a random surrogate of the data, while maintaining a similar temporal and autoregressive structure as the original data.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># We will generate the same plots from above using nltools.stats.phase_randomize()
</span><span class="n">sub</span> <span class="o">=</span> <span class="sh">'</span><span class="s">sub-02</span><span class="sh">'</span>
<span class="n">sampling_freq</span> <span class="o">=</span> <span class="p">.</span><span class="mi">5</span>

<span class="n">f</span><span class="p">,</span><span class="n">a</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">sub_rois</span><span class="p">[</span><span class="n">sub</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Avg Activity</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Time (TR)</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Observed Data</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

<span class="n">fft_data</span> <span class="o">=</span> <span class="nf">fft</span><span class="p">(</span><span class="n">sub_rois</span><span class="p">[</span><span class="n">sub</span><span class="p">])</span>
<span class="n">freq</span> <span class="o">=</span> <span class="nf">fftfreq</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">fft_data</span><span class="p">),</span> <span class="mi">1</span><span class="o">/</span><span class="n">sampling_freq</span><span class="p">)</span>
<span class="n">n_freq</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">floor</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">fft_data</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
<span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">freq</span><span class="p">[:</span><span class="n">n_freq</span><span class="p">],</span> <span class="n">np</span><span class="p">.</span><span class="nf">abs</span><span class="p">(</span><span class="n">fft_data</span><span class="p">)[:</span><span class="n">n_freq</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Frequency (Hz)</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Amplitude</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Power Spectrum</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="n">phase_random_data</span> <span class="o">=</span> <span class="nf">phase_randomize</span><span class="p">(</span><span class="n">sub_rois</span><span class="p">[</span><span class="n">sub</span><span class="p">])</span>
<span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">phase_random_data</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Avg Activity</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Time (TR)</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Phase Randomized Data</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

<span class="n">fft_phase</span> <span class="o">=</span> <span class="nf">fft</span><span class="p">(</span><span class="n">phase_random_data</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">freq</span><span class="p">[:</span><span class="n">n_freq</span><span class="p">],</span> <span class="n">np</span><span class="p">.</span><span class="nf">abs</span><span class="p">(</span><span class="n">fft_phase</span><span class="p">)[:</span><span class="n">n_freq</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Frequency (Hz)</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Amplitude</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Phase Randomized Power Spectrum</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/img/isc/Intersubject%20Correlation_14_0.png" alt="png" width="100%"></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Compute ISC of vmPFC roi with 5000 permutations.
</span><span class="n">stats_phase</span> <span class="o">=</span> <span class="nf">isc</span><span class="p">(</span><span class="n">sub_rois</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="sh">'</span><span class="s">phase_randomize</span><span class="sh">'</span><span class="p">,</span> <span class="n">n_bootstraps</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">return_bootstraps</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ISC: </span><span class="si">{</span><span class="n">stats_phase</span><span class="p">[</span><span class="sh">'</span><span class="s">isc</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">02</span><span class="si">}</span><span class="s">, p = </span><span class="si">{</span><span class="n">stats_phase</span><span class="p">[</span><span class="sh">'</span><span class="s">p</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">03</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ISC: 0.074, p = 0.0001
</code></pre></div></div>

<p>ISC values (median of the pairwise correlations) of the two permutation methods are identical. The p-values are also similar and likely reflect the limited precision of the possible p-values that can be computed using only 5000 permutations. For greater precision, increase the number of permutations but this will take longer to compute.</p>

<h3 id="subject-wise-bootstrapping">Subject-wise Bootstrapping</h3>
<p>Third, subject-wise bootstrapping is more conservative than the previously described permutation methods and is almost an order of magnitude faster shuffling the similarity matrix compared to recomputing the pairwise similarity for the null distribution (Chen et al., 2016). 
Bootstrapping vs Permutation
Bootstrapping is typically used more for generating confidence intervals around an estimator, while permutation tests are used for performing hypothesis tests. However, p-values can also be computed using a bootstrap by subtracting the ISC from the null distribution and evaluating the percent of samples from the distribution that are smaller than the ISC (Hall et al., 1991).</p>

<p>We illustrate what an example bootstrapped similarity matrix looks like.
Due to resampling with replacement, some subjects are repeatedly resampled and there are multiple values of perfect correlations found off the diagonal. 
This can be accounted for by using the median summary statistic of the lower triangle. However, Brainiak and nltools toolboxes convert these values to NaNs to minimize the impact of these outliers on the summary statistic.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">bootstrap_subject_matrix</span><span class="p">(</span><span class="n">similarity_matrix</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sh">'''</span><span class="s">This function shuffles subjects within a similarity matrix based on recommendation by Chen et al.,Â 2016</span><span class="sh">'''</span>
    
    <span class="n">random_state</span> <span class="o">=</span> <span class="nf">check_random_state</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>
    <span class="n">n_sub</span> <span class="o">=</span> <span class="n">similarity_matrix</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">bootstrap_subject</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">random_state</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">n_sub</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">n_sub</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">similarity_matrix</span><span class="p">[</span><span class="n">bootstrap_subject</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">bootstrap_subject</span><span class="p">]</span>


<span class="n">similarity</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="nf">pairwise_distances</span><span class="p">(</span><span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">sub_rois</span><span class="p">).</span><span class="n">T</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="sh">'</span><span class="s">correlation</span><span class="sh">'</span><span class="p">)</span>

<span class="n">f</span><span class="p">,</span><span class="n">a</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">heatmap</span><span class="p">(</span><span class="n">similarity</span><span class="p">,</span> <span class="n">square</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">RdBu_r</span><span class="sh">'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">xticklabels</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Subject</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Subject</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Pairwise Similarity</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

<span class="n">sns</span><span class="p">.</span><span class="nf">heatmap</span><span class="p">(</span><span class="nf">bootstrap_subject_matrix</span><span class="p">(</span><span class="n">similarity</span><span class="p">),</span> <span class="n">square</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">RdBu_r</span><span class="sh">'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">xticklabels</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Subject</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Subject</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Bootstrapped Pairwise Similarity</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Text(0.5, 1.0, 'Bootstrapped Pairwise Similarity')
</code></pre></div></div>

<p><img src="/assets/img/isc/Intersubject%20Correlation_19_1.png" alt="png" width="100%"></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stats_boot</span> <span class="o">=</span> <span class="nf">isc</span><span class="p">(</span><span class="n">sub_rois</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="sh">'</span><span class="s">bootstrap</span><span class="sh">'</span><span class="p">,</span> <span class="n">n_bootstraps</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">return_bootstraps</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ISC: </span><span class="si">{</span><span class="n">stats_boot</span><span class="p">[</span><span class="sh">'</span><span class="s">isc</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">02</span><span class="si">}</span><span class="s">, p = </span><span class="si">{</span><span class="n">stats_boot</span><span class="p">[</span><span class="sh">'</span><span class="s">p</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">03</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ISC: 0.074, p = 0.0002
</code></pre></div></div>

<p>Now that we saved the null distributions, we can plot a histogram of the null distribution from each method including the confidence intervals.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">distplot</span><span class="p">(</span><span class="n">stats_boot</span><span class="p">[</span><span class="sh">'</span><span class="s">null_distribution</span><span class="sh">'</span><span class="p">]</span> <span class="o">-</span> <span class="n">stats_boot</span><span class="p">[</span><span class="sh">'</span><span class="s">isc</span><span class="sh">'</span><span class="p">],</span> <span class="n">kde</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Bootstrap</span><span class="sh">'</span><span class="p">)</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">distplot</span><span class="p">(</span><span class="n">stats_circle</span><span class="p">[</span><span class="sh">'</span><span class="s">null_distribution</span><span class="sh">'</span><span class="p">],</span> <span class="n">kde</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Bootstrap</span><span class="sh">'</span><span class="p">)</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">distplot</span><span class="p">(</span><span class="n">stats_phase</span><span class="p">[</span><span class="sh">'</span><span class="s">null_distribution</span><span class="sh">'</span><span class="p">],</span> <span class="n">kde</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Bootstrap</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Frequency</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">ISC Values (correlation)</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">ISC Null Distribution</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">axvline</span><span class="p">(</span><span class="n">stats_boot</span><span class="p">[</span><span class="sh">'</span><span class="s">isc</span><span class="sh">'</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">-</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">([</span><span class="sh">'</span><span class="s">Observed ISC</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Bootstrap Null</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">Circle Shift Null</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Phase Randomize Null</span><span class="sh">'</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">axvline</span><span class="p">(</span><span class="n">stats_boot</span><span class="p">[</span><span class="sh">'</span><span class="s">ci</span><span class="sh">'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">stats_boot</span><span class="p">[</span><span class="sh">'</span><span class="s">isc</span><span class="sh">'</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">--</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">blue</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">axvline</span><span class="p">(</span><span class="n">stats_boot</span><span class="p">[</span><span class="sh">'</span><span class="s">ci</span><span class="sh">'</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">stats_boot</span><span class="p">[</span><span class="sh">'</span><span class="s">isc</span><span class="sh">'</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">--</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">blue</span><span class="sh">'</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">axvline</span><span class="p">(</span><span class="n">stats_circle</span><span class="p">[</span><span class="sh">'</span><span class="s">ci</span><span class="sh">'</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">--</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">orange</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">axvline</span><span class="p">(</span><span class="n">stats_circle</span><span class="p">[</span><span class="sh">'</span><span class="s">ci</span><span class="sh">'</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">--</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">orange</span><span class="sh">'</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">axvline</span><span class="p">(</span><span class="n">stats_phase</span><span class="p">[</span><span class="sh">'</span><span class="s">ci</span><span class="sh">'</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">--</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">green</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">axvline</span><span class="p">(</span><span class="n">stats_phase</span><span class="p">[</span><span class="sh">'</span><span class="s">ci</span><span class="sh">'</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">--</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">green</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;matplotlib.lines.Line2D at 0x7fcae8aa0d90&gt;
</code></pre></div></div>

<p><img src="/assets/img/isc/Intersubject%20Correlation_22_1.png" alt="png" width="100%"></p>

<p>Notice that the circle shift and phase randomization methods produce highly similar null distributions and confidence intervals.
, while the bootstrap method has a wider and less symmetric distribution with the current number of iterations. 
However, the observed ISC of 0.074 (red line) exceeds all of the samples from the null distribution yielding a very small p-value.</p>

<p>Now, letâ€™s calculate ISC looping over each of the 50 ROIs from the whole-brain.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Loop over each ROI and grab the column from each subject's dataframe : get_subject_roi()
# Run ISC on the combined subject's ROI timeseries using the median method and compute hypothesis test using subject-wise bootstrap with 5000 samples : isc()
# Convert each correlation and p-value from each region back into Brain_Data instance : roi_to_brain()
</span><span class="n">isc_r</span><span class="p">,</span> <span class="n">isc_p</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="nf">isc</span><span class="p">(</span><span class="nf">get_subject_roi</span><span class="p">(</span><span class="n">sub_timeseries</span><span class="p">,</span> <span class="n">roi</span><span class="p">),</span> <span class="n">n_bootstraps</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="sh">'</span><span class="s">median</span><span class="sh">'</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="sh">'</span><span class="s">bootstrap</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">isc_r</span><span class="p">[</span><span class="n">roi</span><span class="p">],</span> <span class="n">isc_p</span><span class="p">[</span><span class="n">roi</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="sh">'</span><span class="s">isc</span><span class="sh">'</span><span class="p">],</span> <span class="n">stats</span><span class="p">[</span><span class="sh">'</span><span class="s">p</span><span class="sh">'</span><span class="p">]</span>
<span class="n">isc_r_brain</span><span class="p">,</span> <span class="n">isc_p_brain</span> <span class="o">=</span> <span class="nf">roi_to_brain</span><span class="p">(</span><span class="n">pd</span><span class="p">.</span><span class="nc">Series</span><span class="p">(</span><span class="n">isc_r</span><span class="p">),</span> <span class="n">mask_x</span><span class="p">),</span> <span class="nf">roi_to_brain</span><span class="p">(</span><span class="n">pd</span><span class="p">.</span><span class="nc">Series</span><span class="p">(</span><span class="n">isc_p</span><span class="p">),</span> <span class="n">mask_x</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Plot the ISC values to visualize which regions had a higher overall ISC
</span><span class="n">isc_r_brain</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">RdBu_r</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/assets/img/isc/Intersubject%20Correlation_26_0.png" alt="png" width="100%"></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">view_img</span><span class="p">(</span><span class="n">isc_r_brain</span><span class="p">.</span><span class="nf">to_nifti</span><span class="p">())</span>
</code></pre></div></div>
<iframe src="/assets/isc_r_brain.html" height="450px" width="100%" style="border:none;"></iframe>

<p>Now, letâ€™s threshold using bonferroni correction (p&lt;0.001 for k=50 parcellation). Alternatively, we can threshold using false discovery rate by setting thr=fdr(isc_p_brain.data).
Here, FDR is more conservative than bonferroni (try for yourself!).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">view_img_on_surf</span><span class="p">(</span><span class="nf">threshold</span><span class="p">(</span><span class="n">isc_r_brain</span><span class="p">,</span> <span class="n">isc_p_brain</span><span class="p">,</span> <span class="n">thr</span><span class="o">=</span><span class="p">.</span><span class="mi">001</span><span class="p">).</span><span class="nf">to_nifti</span><span class="p">())</span>
<span class="c1">#view_img_on_surf(threshold(isc_r_brain, isc_p_brain, thr=fdr(isc_p_brain.data)).to_nifti())
</span></code></pre></div></div>
<iframe src="/assets/surface_view_isc_r_brain.html" height="450px" width="100%" style="border:none;"></iframe>

<h2 id="intersubject-functional-connectivity">Intersubject Functional Connectivity</h2>
<p>We demonstrate how to perform ISFC using the averaging method. We iterate over each subject and compute the cross-correlation between each of the target subjectâ€™s ROIs with the average ROI response of the other subjects. This yields a separate ROI x ROI ISFC matrix for each subject. We use nltools.stats.isfc() but check out the Brainiak implementation for a faster and more feature rich option. I will do both :)</p>

<p>Plot the average of these ROI x ROI ISFC matrices as a heatmap.
The diagonal reflects the ROIâ€™s ISC using the averaging method (rather than the pairwise method in the previous examples). 
Off diagonal values reflect the average ISFC between each ROI.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">sub_timeseries</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

<span class="n">isfc_output</span> <span class="o">=</span> <span class="nf">isfc</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="c1">#isfc_output = brainiak.isc.isfc(data)
</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">heatmap</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">isfc_output</span><span class="p">).</span><span class="nf">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">square</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">RdBu_r</span><span class="sh">'</span><span class="p">,</span> <span class="n">xticklabels</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">Average ISFC</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">ROI</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">ROI</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Text(96.78333333333339, 0.5, 'ROI')
</code></pre></div></div>

<p><img src="/assets/img/isc/Intersubject%20Correlation_32_1.png" alt="png" width="100%"></p>

<p>We can threshold the ISFC matrix by running a one-sample t-test on each ISFC value and correcting for multiple comparisons using FDR.
We can convert this into an adjacency matrix, by binarizing the continuous t-values. In this example, we are interested in exploring which regions have a positive ISFC. Thus, we use an arbitrary fdr threshold (q&lt;0.000001) in this example to create a sparse adjacency matrix.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">t</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="nf">ttest_1samp</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">x</span><span class="p">.</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">isfc_output</span><span class="p">]),</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">thresh</span> <span class="o">=</span> <span class="nf">fdr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">.</span><span class="mi">0000001</span><span class="p">)</span>
<span class="n">thresholded_t_pos</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
<span class="n">thresholded_t_pos</span><span class="p">[</span><span class="n">p</span> <span class="o">&gt;</span> <span class="n">thresh</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">thresholded_t_pos</span><span class="p">[</span><span class="n">thresholded_t_pos</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">thresholded_t_pos</span><span class="p">[</span><span class="n">thresholded_t_pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">thresholded_t_pos</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">reshape</span><span class="p">(</span><span class="n">thresholded_t_pos</span><span class="p">,</span> <span class="n">isfc_output</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">shape</span><span class="p">)</span>

<span class="n">sns</span><span class="p">.</span><span class="nf">heatmap</span><span class="p">(</span><span class="n">thresholded_t_pos</span><span class="p">,</span> <span class="n">square</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">xticklabels</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">Positive ISFC Edges</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">ROI</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">ROI</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Text(96.78333333333339, 0.5, 'ROI')
</code></pre></div></div>

<p><img src="/assets/img/isc/Intersubject%20Correlation_34_1.png" alt="png" width="100%"></p>

<p>We can now convert this adjacency matrix into a graph and can visualize which regions are functionally connected to the most other regions.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">plot_network</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sh">'''</span><span class="s">Plot the degree of the thresholded isfc Adjaceny matrix</span><span class="sh">'''</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Adjacency</span><span class="p">):</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">'</span><span class="s">data must be an Adjacency instance.</span><span class="sh">'</span><span class="p">)</span>
        
    <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">to_graph</span><span class="p">()</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">nx</span><span class="p">.</span><span class="nf">kamada_kawai_layout</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
    <span class="n">node_and_degree</span> <span class="o">=</span> <span class="n">G</span><span class="p">.</span><span class="nf">degree</span><span class="p">()</span>
    <span class="n">nx</span><span class="p">.</span><span class="nf">draw_networkx_edges</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="p">.</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">nx</span><span class="p">.</span><span class="nf">draw_networkx_labels</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">font_color</span><span class="o">=</span><span class="sh">'</span><span class="s">darkslategray</span><span class="sh">'</span><span class="p">)</span>

    <span class="n">nx</span><span class="p">.</span><span class="nf">draw_networkx_nodes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">nodelist</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">node_and_degree</span><span class="p">).</span><span class="nf">keys</span><span class="p">()),</span>
                           <span class="n">node_size</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">node_and_degree</span><span class="p">],</span>
                           <span class="n">node_color</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">node_and_degree</span><span class="p">).</span><span class="nf">values</span><span class="p">()),</span>
                           <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="n">Reds_r</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="sh">'</span><span class="s">darkslategray</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
<span class="nf">plot_network</span><span class="p">(</span><span class="nc">Adjacency</span><span class="p">(</span><span class="n">thresholded_t_pos</span><span class="p">,</span> <span class="n">matrix_type</span><span class="o">=</span><span class="sh">'</span><span class="s">similarity</span><span class="sh">'</span><span class="p">))</span>
</code></pre></div></div>

<p><img src="/assets/img/isc/Intersubject%20Correlation_36_0.png" alt="png" width="100%"></p>

<p>To interpret this, letâ€™s project the number of connections (i.e. degree) with each node back into brain space.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">degree</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">Series</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="nc">Adjacency</span><span class="p">(</span><span class="n">thresholded_t_pos</span><span class="p">,</span> <span class="n">matrix_type</span><span class="o">=</span><span class="sh">'</span><span class="s">similarity</span><span class="sh">'</span><span class="p">).</span><span class="nf">to_graph</span><span class="p">().</span><span class="nf">degree</span><span class="p">()))</span>
<span class="n">brain_degree</span> <span class="o">=</span> <span class="nf">roi_to_brain</span><span class="p">(</span><span class="n">degree</span><span class="p">,</span> <span class="n">mask_x</span><span class="p">)</span>
<span class="n">brain_degree</span><span class="p">.</span><span class="nf">plot</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/img/isc/Intersubject%20Correlation_38_0.png" alt="png" width="100%"></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">view_img_on_surf</span><span class="p">(</span><span class="n">brain_degree</span><span class="p">.</span><span class="nf">to_nifti</span><span class="p">())</span>
</code></pre></div></div>

<iframe src="/assets/surface_view_brain_degree.html" height="450px" width="100%" style="border:none;"></iframe>

<h2 id="temporal-dynamics-of-intersubject-synchrony">Temporal Dynamics of Intersubject Synchrony</h2>
<p>This section will help you build an intuition for the core concepts behind intersubject phase synchrony (ISPS). We will begin by creating an animation of the phase angles.</p>

<p>First, we will compute the instantaneous phase angle of average ROI activity for each subject. We will use an infinite impulse response (IIR) bandpass butterworth filter. This requires specifying the sampling_frequency in cycles per second (Hz) which is 1/tr, and lower and upper cutoff frequencies also in Hz. Then we will apply a hilbert transform and extract the phase angle for each time point.</p>

<p>Here, we extract signal from primary auditory cortex(roi 35) which we assume will synchronize strongly across participants, and use a lower bound cutoff frequency of 0.04Hz and an upper bound of 0.07Hz as recommended by Glerean et al. (2012).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">roi</span> <span class="o">=</span> <span class="mi">35</span>
<span class="n">tr</span> <span class="o">=</span> <span class="mf">1.5</span>
<span class="n">lowcut</span> <span class="o">=</span> <span class="p">.</span><span class="mi">04</span>
<span class="n">highcut</span> <span class="o">=</span> <span class="p">.</span><span class="mi">07</span>

<span class="n">phase_angles</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">angle</span><span class="p">(</span><span class="nf">hilbert</span><span class="p">(</span><span class="nf">_butter_bandpass_filter</span><span class="p">(</span><span class="nf">get_subject_roi</span><span class="p">(</span><span class="n">sub_timeseries</span><span class="p">,</span> <span class="n">roi</span><span class="p">),</span> <span class="n">lowcut</span><span class="p">,</span> <span class="n">highcut</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">tr</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</code></pre></div></div>

<p>To visualize data, we will plot 100 TRs of each participantâ€™s phase angles from the auditory cortex using a polar plot. 
For some time points all subjects have a different phase angle. These time points should have low synchrony values (i.e. resultant vector length close to zero). 
Other time points the phase angles will cluster together and all face the same direction. These time points will have high phase synchrony (i.e. resultant vector length close to one).
We can also comput the mean phase angle for the group using circular statistics (red line). We donâ€™t care so much about the mean angle bu rather the <strong>length of the resultant vector</strong>. This is our metric of intersubject phase clustering, or the degree to which participants are in phase with each other at a given time point. Notice how the length gets shorter the more participants are our of phase and longer when they are all facing the same direction.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">constrained_layout</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">spec</span> <span class="o">=</span> <span class="n">gridspec</span><span class="p">.</span><span class="nc">GridSpec</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>

<span class="n">a0</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">(</span><span class="n">spec</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="sh">'</span><span class="s">polar</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">polar</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nf">_phase_mean_angle</span><span class="p">(</span><span class="n">phase_angles</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">a1</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">(</span><span class="n">spec</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="sh">'</span><span class="s">polar</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">polar</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">phase_angles</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">navy</span><span class="sh">'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span>

<span class="n">a2</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="mi">2</span><span class="p">:,</span> <span class="p">:])</span>
<span class="n">a2</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="nf">_phase_vector_length</span><span class="p">(</span><span class="n">phase_angles</span><span class="p">))</span>
<span class="n">a2</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Phase Synchrony</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">a2</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Time (TRs)</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">animate</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">):</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">phase_angles</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    
    <span class="n">a0</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
    <span class="n">a0</span><span class="p">.</span><span class="nf">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nf">_phase_mean_angle</span><span class="p">(</span><span class="n">phase_angles</span><span class="p">[</span><span class="n">i</span><span class="p">,:])],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="nf">_phase_vector_length</span><span class="p">(</span><span class="n">phase_angles</span><span class="p">[</span><span class="n">i</span><span class="p">,:])],</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">a0</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Mean Phase Angle</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
    <span class="n">a0</span><span class="p">.</span><span class="nf">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="n">a1</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">ys</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">a1</span><span class="p">.</span><span class="nf">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">phase_angles</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">navy</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span>  
    <span class="n">a1</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Subject Phase Angles</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

    <span class="n">a2</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
    <span class="n">a2</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="nf">_phase_vector_length</span><span class="p">(</span><span class="n">ys</span><span class="p">))</span>
    <span class="n">a2</span><span class="p">.</span><span class="nf">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">a2</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Resultant Vector Length</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
    <span class="n">a2</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Time (TRs)</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
    <span class="n">a2</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Intersubject Phase Synchrony</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
    
<span class="n">animation</span> <span class="o">=</span> <span class="nc">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">animate</span><span class="p">,</span> <span class="n">fargs</span><span class="o">=</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">),</span> <span class="n">frames</span><span class="o">=</span><span class="nf">range</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">200</span><span class="p">),</span> <span class="n">interval</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">blit</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">animation</span><span class="p">.</span><span class="n">_fig</span><span class="p">)</span>
<span class="nc">HTML</span><span class="p">(</span><span class="n">animation</span><span class="p">.</span><span class="nf">to_jshtml</span><span class="p">())</span>
</code></pre></div></div>

<iframe src="/assets/intersubject_phase_sync.html" height="750px" width="100%" style="border:none;"></iframe>

<p>Now, letâ€™s pick a frequency band and plot the average phase synchrony over the entire 50min Sherlock viewing within each ROI from out parcellation. Letâ€™s continue using a lower bound cutoff frequency of 0.04Hz and an upper bound of 0.07Hz.</p>

<p>We loop over each ROI and compute average ISPS over time and then project back into brain space.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cutoff</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.07</span><span class="p">)</span>
<span class="n">synchrony</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
    <span class="n">synchrony</span><span class="p">[</span><span class="n">roi</span><span class="p">]</span> <span class="o">=</span> <span class="nf">isps</span><span class="p">(</span><span class="nf">get_subject_roi</span><span class="p">(</span><span class="n">sub_timeseries</span><span class="p">,</span> <span class="n">roi</span><span class="p">),</span> <span class="n">low_cut</span><span class="o">=</span><span class="n">cutoff</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">high_cut</span><span class="o">=</span><span class="n">cutoff</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sampling_freq</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">tr</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">5</span><span class="p">)[</span><span class="sh">'</span><span class="s">vector_length</span><span class="sh">'</span><span class="p">]</span>
<span class="n">synchrony</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">synchrony</span><span class="p">)</span>

<span class="n">phase_synchrony_brain</span> <span class="o">=</span> <span class="nf">roi_to_brain</span><span class="p">(</span><span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">synchrony</span><span class="p">).</span><span class="nf">mean</span><span class="p">(),</span> <span class="n">mask_x</span><span class="p">)</span>
<span class="n">phase_synchrony_brain</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">RdBu_r</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/assets/img/isc/Intersubject%20Correlation_45_0.png" alt="png" width="100%"></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create an interactive surface rendering
</span><span class="nf">view_img_on_surf</span><span class="p">(</span><span class="n">phase_synchrony_brain</span><span class="p">.</span><span class="nf">to_nifti</span><span class="p">())</span>
</code></pre></div></div>

<iframe src="/assets/surface_view_brain_sync.html" height="450px" width="100%" style="border:none;"></iframe>

<p>You can see that these results look very similar to the whole timeseries ISC apporach we used above. High overall synchrony across participants within primary auditory and visual cortices and lower overall synchrony in prefrontal and limbic regions.</p>

<p>Previously, we looked at a specific frequency band (0.04-0.07Hz). Itâ€™s possible that participants might differently synchronize within different frequency bands (Honey et al., 2012; Kauppi et al., 2010). 
Letâ€™s create a time-frequency plot to see how ISPS changes over time within different frequency for a given ROI. We will explore the dorsomedial prefrontal cortex (roi 2).</p>

<p>We will loop over different cutoff bands. These values are based on the slow frequency bands described in Buszaki &amp; Draguhun (2003) and Zuo et al. (2010), but are admittedly somewhat arbitrarily selected. Brighter colors indicate time points that have a higher level of ISPS within a specific TR.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tr</span> <span class="o">=</span> <span class="mf">1.5</span>
<span class="n">roi</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">frequencies</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.027</span><span class="p">),(</span><span class="mf">0.027</span><span class="p">,</span> <span class="mf">0.073</span><span class="p">),(</span><span class="mf">0.073</span><span class="p">,</span> <span class="mf">0.198</span><span class="p">),(</span><span class="mf">0.198</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)]</span>

<span class="n">time_freq</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">cutoff</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">frequencies</span><span class="p">):</span>
    <span class="n">time_freq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">isps</span><span class="p">(</span><span class="nf">get_subject_roi</span><span class="p">(</span><span class="n">sub_timeseries</span><span class="p">,</span> <span class="n">roi</span><span class="p">),</span> <span class="n">low_cut</span><span class="o">=</span><span class="n">cutoff</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">high_cut</span><span class="o">=</span><span class="n">cutoff</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sampling_freq</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">tr</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">5</span><span class="p">)[</span><span class="sh">'</span><span class="s">vector_length</span><span class="sh">'</span><span class="p">]</span>
    
<span class="n">time_freq</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">time_freq</span><span class="p">).</span><span class="n">T</span>
<span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">time_freq</span><span class="p">).</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">0.01 - .027Hz</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">0.027 - 0.073Hz</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">0.073 - 0.198Hz</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">0.198 - 0.25Hz</span><span class="sh">'</span><span class="p">]</span>

<span class="n">mask_x</span><span class="p">[</span><span class="n">roi</span><span class="p">].</span><span class="nf">plot</span><span class="p">()</span>
<span class="n">f</span><span class="p">,</span><span class="n">a</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">heatmap</span><span class="p">(</span><span class="n">time_freq</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">hot</span><span class="sh">'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">xticklabels</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">a</span><span class="p">)</span>
<span class="n">a</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">ROI Time - Frequency Analysis</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">a</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Frequency Band (Hz)</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">a</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Time (TRs)</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/img/isc/Intersubject%20Correlation_49_0.png" alt="png" width="100%"></p>

<p><img src="/assets/img/isc/Intersubject%20Correlation_49_1.png" alt="png" width="100%"></p>

<p>Hypothesis test</p>

<p>Statistics for time-varying measures of synchrony largely follow a similar non-parametric approach as discussed above. However, depending on the values used, statistics of phase synchrony differ slightly from linear measures of synchrony. In particular, circular statistics (Fisher, 1995) can be used to estimate the parametric statistics of phase differences on the unit circle, as wrapping of the phase angle (change the range of angle) cause the angular difference to change signs as the signals rotate around the circle.</p>

<p>For a parametric test, we use the Rayleigh test to determine if the ISPS is statistically significant, by testing the null hypothesis that the phase angles are uniformly distributed around a circle (Fisher, 1995). If the phase angles cluster together in specific direction, they will have a large resultant vector and we can rejct the null uniformity hypothesis.</p>

<p>Letâ€™s simulate what ISPS values would be significant at p&lt;0.05 given the sample size of N=16 in the Sherlock dataset. 
Plot the estimated p-values using the Rayleigh test across ISPS values ranging from [0,1].</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">n</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="mi">01</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">R</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">Z</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Z</span> <span class="o">-</span> <span class="n">Z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">24</span><span class="o">*</span><span class="n">Z</span> <span class="o">-</span> <span class="mi">132</span><span class="o">*</span><span class="n">Z</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span><span class="mi">76</span><span class="o">*</span><span class="n">Z</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="mi">9</span><span class="o">*</span><span class="n">Z</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">288</span><span class="o">*</span><span class="n">n</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">axhline</span><span class="p">(.</span><span class="mi">05</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">--</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">axvline</span><span class="p">(.</span><span class="mi">43</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">--</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">darkgrey</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">p-Value</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Synchrony (Resultant Vector)</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">Rayleigh p-value Simulation for N=16</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">([</span><span class="sh">'</span><span class="s">ISPS Values</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">p &lt; 0.05</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">ISPS =Â 0.43</span><span class="sh">'</span><span class="p">])</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;matplotlib.legend.Legend at 0x7fcae8810d90&gt;
</code></pre></div></div>

<p><img src="/assets/img/isc/Intersubject%20Correlation_51_1.png" alt="png" width="100%"></p>

<p>For N=16, an ISPS value of 0.43 corresponds to a significance value of approximately p&lt;0.05. This number will decrease as the number of participants increases and approaches the central limit theorem like any significance test.</p>

<p>Note that you will need to consider controlling for multiple comparisons when repeated testing the same hypothesis across either space or time.</p>

<p>Now, letâ€™s put this all together and compute ISPS at different frequency bands thresholding at a very liberal threshold of p&lt;0.05.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">f</span><span class="p">,</span><span class="n">a</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">nrows</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">frequencies</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">cutoff</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">frequencies</span><span class="p">):</span>
    <span class="n">synchrony</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
        <span class="n">synchrony</span><span class="p">[</span><span class="n">roi</span><span class="p">]</span> <span class="o">=</span> <span class="nf">isps</span><span class="p">(</span><span class="nf">get_subject_roi</span><span class="p">(</span><span class="n">sub_timeseries</span><span class="p">,</span> <span class="n">roi</span><span class="p">),</span> <span class="n">low_cut</span><span class="o">=</span><span class="n">cutoff</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">high_cut</span><span class="o">=</span><span class="n">cutoff</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sampling_freq</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">tr</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">5</span><span class="p">)[</span><span class="sh">'</span><span class="s">vector_length</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">phase_synchrony_brain</span> <span class="o">=</span> <span class="nf">roi_to_brain</span><span class="p">(</span><span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">synchrony</span><span class="p">).</span><span class="nf">mean</span><span class="p">(),</span> <span class="n">mask_x</span><span class="p">)</span>
    <span class="n">phase_synchrony_brain</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">RdBu_r</span><span class="sh">'</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">threshold</span><span class="o">=</span><span class="p">.</span><span class="mi">43</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">Frequency cutoff: </span><span class="si">{</span><span class="n">cutoff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> - </span><span class="si">{</span><span class="n">cutoff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/assets/img/isc/Intersubject%20Correlation_53_0.png" alt="png" width="100%"></p>

<p>ISPS Functional Connectivity Analysis.</p>

<p>There are lots of interesting potential analysis made possible by dynamic conenctivity measures such as ISPS, and a very exploratory ISPS functional connectivity analysis.</p>

<p>Here, we will explore which brain regions have a similar shared dynamic synchrony while watching Sherlock. Note that this is slightly different to the ISFC analysis above as we are calculating the similarity of local synchrony rather similarity of brain activity directly. We simply compute the <strong>pairwise temporal similarity of each ROIâ€™s ISPS time series.</strong> We can threshold these correlations with an arbitrary threshold to create a sparse adjency matrix.</p>

<p><strong>Thoughts:</strong> I am a bit skeptical about interpreting this metric. ISPS represents how similar time-varying brain activities are among participants for each ROI. Then, we compute the pairwise temporal similarity of those similarities for all ROIs. This does not seem to be a true metric of how similarity of activity timecourses between ROIs (FC) are dynamically synchronized between participants. Instead, the time-varying FC should be calculated for each subject and then</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">synchrony</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="nf">isps</span><span class="p">(</span><span class="nf">get_subject_roi</span><span class="p">(</span><span class="n">sub_timeseries</span><span class="p">,</span> <span class="n">roi</span><span class="p">),</span> <span class="n">low_cut</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">high_cut</span><span class="o">=</span><span class="mf">0.027</span><span class="p">,</span> <span class="n">sampling_freq</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">tr</span><span class="p">)</span>
    <span class="n">synchrony</span><span class="p">[</span><span class="n">roi</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="sh">'</span><span class="s">vector_length</span><span class="sh">'</span><span class="p">]</span>
<span class="n">synchrony</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">synchrony</span><span class="p">)</span>

<span class="n">sync</span> <span class="o">=</span> <span class="nc">Adjacency</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nf">pairwise_distances</span><span class="p">(</span><span class="n">synchrony</span><span class="p">.</span><span class="n">T</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="sh">'</span><span class="s">correlation</span><span class="sh">'</span><span class="p">),</span> <span class="n">matrix_type</span><span class="o">=</span><span class="sh">'</span><span class="s">similarity</span><span class="sh">'</span><span class="p">)</span>

<span class="n">f</span><span class="p">,</span><span class="n">a</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">sync</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">RdBu_r</span><span class="sh">'</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cbar</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">sync</span><span class="p">.</span><span class="nf">threshold</span><span class="p">(</span><span class="n">upper</span> <span class="o">=</span> <span class="p">.</span><span class="mi">25</span><span class="p">,</span> <span class="n">binarize</span><span class="o">=</span><span class="bp">True</span><span class="p">).</span><span class="nf">plot</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cbar</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">ISPS Functional Connectivity Matrix</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Thresholded ISPS Functional Connectivity Matrix</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/img/isc/Intersubject%20Correlation_55_0.png" alt="png" width="100%"></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create a graph of the thresholded edges using the networkx package
</span><span class="nf">plot_network</span><span class="p">(</span><span class="n">sync</span><span class="p">.</span><span class="nf">threshold</span><span class="p">(</span><span class="n">upper</span> <span class="o">=</span> <span class="p">.</span><span class="mi">3</span><span class="p">,</span> <span class="n">binarize</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
</code></pre></div></div>

<p><img src="/assets/img/isc/Intersubject%20Correlation_56_0.png" alt="png" width="100%"></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Calculate the degree for each node and project back into brain space
</span><span class="n">degree</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">Series</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">sync</span><span class="p">.</span><span class="nf">threshold</span><span class="p">(</span><span class="n">upper</span><span class="o">=</span><span class="p">.</span><span class="mi">2</span><span class="p">,</span> <span class="n">binarize</span><span class="o">=</span><span class="bp">True</span><span class="p">).</span><span class="nf">to_graph</span><span class="p">().</span><span class="nf">degree</span><span class="p">()))</span>
<span class="n">brain_degree</span> <span class="o">=</span> <span class="nf">roi_to_brain</span><span class="p">(</span><span class="n">degree</span><span class="p">,</span> <span class="n">mask_x</span><span class="p">)</span>
<span class="n">brain_degree</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">RdBu_r</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/assets/img/isc/Intersubject%20Correlation_57_0.png" alt="png" width="100%"></p>

  </article>

</div>

    </div>

    <!-- Footer -->    
    <footer class="fixed-bottom">
      <div class="container mt-0">
        Â© Copyright 2023 Naeun  Oh. Powered by <a href="http://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" target="_blank" rel="noopener noreferrer">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="noopener noreferrer">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="noopener noreferrer">Unsplash</a>.

      </div>
    </footer>

    <!-- JavaScripts -->
    <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <!-- Bootsrap & MDB scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.2/dist/umd/popper.min.js" integrity="sha256-l/1pMF/+J4TThfgARS6KwWrk/egwuVvhRzfLAMQ6Ds4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js" integrity="sha256-SyTu6CwrfOhaznYZPoolVw2rxoY7lKYKQvqbtqN93HI=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script>

    <!-- Mansory & imagesLoaded -->
  <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
  <script defer src="/assets/js/mansory.js" type="text/javascript"></script>
    
  <!-- Medium Zoom JS -->
  <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
  <script src="/assets/js/zoom.js"></script><!-- Load Common JS -->
  <script src="/assets/js/common.js"></script>

    <!-- MathJax -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        tags: 'ams'
      }
    };
  </script>
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
  <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    
  </body>
</html>

